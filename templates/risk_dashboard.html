{% extends "layout.html" %}

{% block title %}Risk Dashboard{% endblock %}

{% block content %}
<style>
  :root {
    --bg-dark: #131722;
    --bg-card: #1e222d;
    --text-primary: #d1d4dc;
    --text-secondary: #787b86;
    --border-color: #2a2e39;
    --color-up: #089981;
    --color-down: #f23645;
    --color-warning: #f0b90b;
    --color-info: #2196f3;
  }

  body {
    background-color: var(--bg-dark) !important;
    color: var(--text-primary) !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif;
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-color);
  }

  .dashboard-title {
    font-size: 24px;
    font-weight: 600;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px;
  }

  .card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid var(--border-color);
  }

  .card-title {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .big-number {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .big-number.positive { color: var(--color-up); }
  .big-number.negative { color: var(--color-down); }
  .big-number.neutral { color: var(--text-primary); }

  .sub-text {
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* Gauge Meter */
  .gauge-container {
    position: relative;
    width: 100%;
    height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .gauge {
    width: 160px;
    height: 80px;
    position: relative;
    overflow: hidden;
  }

  .gauge-bg {
    width: 160px;
    height: 80px;
    border-radius: 80px 80px 0 0;
    background: linear-gradient(90deg, var(--color-up) 0%, var(--color-warning) 50%, var(--color-down) 100%);
    position: absolute;
  }

  .gauge-mask {
    width: 120px;
    height: 60px;
    border-radius: 60px 60px 0 0;
    background: var(--bg-card);
    position: absolute;
    bottom: 0;
    left: 20px;
  }

  .gauge-needle {
    width: 4px;
    height: 50px;
    background: white;
    position: absolute;
    bottom: 0;
    left: 78px;
    transform-origin: bottom center;
    transition: transform 0.5s ease;
    border-radius: 2px;
  }

  .gauge-value {
    font-size: 24px;
    font-weight: 600;
    margin-top: 10px;
  }

  .gauge-label {
    font-size: 12px;
    color: var(--text-secondary);
  }

  /* Progress Bar */
  .progress-container {
    margin: 16px 0;
  }

  .progress-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 13px;
  }

  .progress-bar {
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .progress-fill.green { background: var(--color-up); }
  .progress-fill.yellow { background: var(--color-warning); }
  .progress-fill.red { background: var(--color-down); }

  /* Risk Level Badge */
  .risk-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .risk-badge.low { background: rgba(8, 153, 129, 0.2); color: var(--color-up); }
  .risk-badge.medium { background: rgba(240, 185, 11, 0.2); color: var(--color-warning); }
  .risk-badge.high { background: rgba(242, 54, 69, 0.2); color: var(--color-down); }
  .risk-badge.critical { background: var(--color-down); color: white; }

  /* Metrics Grid */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-top: 16px;
  }

  .metric-item {
    text-align: center;
    padding: 12px;
    background: rgba(42, 46, 57, 0.5);
    border-radius: 8px;
  }

  .metric-value {
    font-size: 20px;
    font-weight: 600;
  }

  .metric-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  /* Position List */
  .position-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .position-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
  }

  .position-item:last-child {
    border-bottom: none;
  }

  .position-symbol {
    font-weight: 600;
  }

  .position-details {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .position-pnl {
    text-align: right;
  }

  .confidence-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
  }

  .confidence-fill {
    width: 60px;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
  }

  .confidence-fill-inner {
    height: 100%;
    background: var(--color-info);
    border-radius: 2px;
  }

  .alert-list {
    max-height: 200px;
    overflow-y: auto;
  }

  .alert-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 13px;
  }

  .alert-item:last-child {
    border-bottom: none;
  }

  .alert-icon {
    font-size: 16px;
  }

  /* Auto-refresh indicator */
  .refresh-indicator {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .refresh-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-up);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Capital Allocator */
  .allocator-section {
    margin-top: 20px;
  }

  .allocator-bar {
    display: flex;
    height: 24px;
    border-radius: 12px;
    overflow: hidden;
    background: var(--border-color);
  }

  .allocator-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    transition: width 0.3s ease;
  }

  .allocator-segment.crypto { background: #f7931a; }
  .allocator-segment.stocks { background: #2196f3; }
  .allocator-segment.cash { background: #666; }

  .allocator-legend {
    display: flex;
    gap: 20px;
    margin-top: 12px;
    font-size: 13px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .legend-dot.crypto { background: #f7931a; }
  .legend-dot.stocks { background: #2196f3; }
  .legend-dot.cash { background: #666; }
</style>

<div class="dashboard-header">
  <div class="dashboard-title">üìä Risk Dashboard</div>
  <div class="refresh-indicator">
    <div class="refresh-dot"></div>
    <span>Auto-refreshing every 10s</span>
  </div>
</div>

<div class="dashboard-grid">
  <!-- Portfolio Overview -->
  <div class="card">
    <div class="card-title">Portfolio Value</div>
    <div class="big-number neutral" id="total-equity">$10,000.00</div>
    <div class="sub-text">
      <span id="daily-pnl" class="positive">+$0.00 (0.00%)</span> today
    </div>
    
    <div class="allocator-section">
      <div class="allocator-bar">
        <div class="allocator-segment crypto" id="alloc-crypto" style="width: 40%">40%</div>
        <div class="allocator-segment stocks" id="alloc-stocks" style="width: 35%">35%</div>
        <div class="allocator-segment cash" id="alloc-cash" style="width: 25%">25%</div>
      </div>
      <div class="allocator-legend">
        <div class="legend-item"><div class="legend-dot crypto"></div> Crypto</div>
        <div class="legend-item"><div class="legend-dot stocks"></div> Stocks</div>
        <div class="legend-item"><div class="legend-dot cash"></div> Cash</div>
      </div>
    </div>
  </div>

  <!-- Risk Level Gauge -->
  <div class="card">
    <div class="card-title">Risk Level</div>
    <div class="gauge-container">
      <div class="gauge">
        <div class="gauge-bg"></div>
        <div class="gauge-mask"></div>
        <div class="gauge-needle" id="risk-needle" style="transform: rotate(-45deg)"></div>
      </div>
      <div class="gauge-value" id="risk-level-text">LOW</div>
      <div class="gauge-label">Portfolio Risk</div>
    </div>
    <div style="text-align: center; margin-top: 16px;">
      <span class="risk-badge low" id="risk-badge">LOW RISK</span>
    </div>
  </div>

  <!-- VaR Meter -->
  <div class="card">
    <div class="card-title">Value at Risk (95%)</div>
    <div class="big-number neutral" id="var-value">$250.00</div>
    <div class="sub-text">Maximum expected daily loss</div>
    
    <div class="progress-container">
      <div class="progress-label">
        <span>VaR Utilization</span>
        <span id="var-util">50%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill green" id="var-fill" style="width: 50%"></div>
      </div>
    </div>
    
    <div class="metrics-grid">
      <div class="metric-item">
        <div class="metric-value" id="var-limit">$500</div>
        <div class="metric-label">VaR Limit</div>
      </div>
      <div class="metric-item">
        <div class="metric-value" id="var-remaining">$250</div>
        <div class="metric-label">Remaining</div>
      </div>
    </div>
  </div>

  <!-- Drawdown -->
  <div class="card">
    <div class="card-title">Drawdown</div>
    <div class="big-number neutral" id="drawdown-value">-2.5%</div>
    <div class="sub-text">From peak equity of <span id="peak-equity">$10,250</span></div>
    
    <div class="progress-container">
      <div class="progress-label">
        <span>Drawdown vs Limit</span>
        <span id="dd-percent">25% of limit</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill green" id="dd-fill" style="width: 25%"></div>
      </div>
    </div>
    
    <div class="metrics-grid">
      <div class="metric-item">
        <div class="metric-value" id="max-dd-limit">10%</div>
        <div class="metric-label">Max Allowed</div>
      </div>
      <div class="metric-item">
        <div class="metric-value" id="pause-threshold">8%</div>
        <div class="metric-label">Pause Threshold</div>
      </div>
    </div>
  </div>

  <!-- Performance Metrics -->
  <div class="card">
    <div class="card-title">Performance Metrics</div>
    <div class="metrics-grid">
      <div class="metric-item">
        <div class="metric-value positive" id="sharpe-ratio">1.45</div>
        <div class="metric-label">Sharpe Ratio</div>
      </div>
      <div class="metric-item">
        <div class="metric-value positive" id="sortino-ratio">2.10</div>
        <div class="metric-label">Sortino Ratio</div>
      </div>
      <div class="metric-item">
        <div class="metric-value" id="win-rate">65%</div>
        <div class="metric-label">Win Rate</div>
      </div>
      <div class="metric-item">
        <div class="metric-value" id="profit-factor">2.1</div>
        <div class="metric-label">Profit Factor</div>
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <div class="sub-text" style="margin-bottom: 8px;">Risk-Adjusted Performance</div>
      <div id="sharpe-comment" style="font-size: 14px;">
        üëç Good risk-adjusted returns
      </div>
    </div>
  </div>

  <!-- Diversification -->
  <div class="card">
    <div class="card-title">Diversification</div>
    <div class="gauge-container" style="height: 100px;">
      <div class="big-number neutral" id="div-score">75%</div>
      <div class="gauge-label">Diversification Score</div>
    </div>
    
    <div class="progress-container">
      <div class="progress-label">
        <span>Correlation Risk</span>
        <span id="corr-risk">Low</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill green" id="corr-fill" style="width: 30%"></div>
      </div>
    </div>
    
    <div class="metrics-grid">
      <div class="metric-item">
        <div class="metric-value" id="position-count">5</div>
        <div class="metric-label">Positions</div>
      </div>
      <div class="metric-item">
        <div class="metric-value" id="positions-avail">5</div>
        <div class="metric-label">Available</div>
      </div>
    </div>
  </div>

  <!-- Active Positions -->
  <div class="card" style="grid-column: span 2;">
    <div class="card-title">Active Positions</div>
    <div class="position-list" id="position-list">
      <div class="position-item">
        <div>
          <div class="position-symbol">BTC/USD</div>
          <div class="position-details">Trend Momentum ‚Ä¢ Entry: $42,150</div>
          <div class="confidence-bar">
            <span style="font-size: 11px; color: var(--text-secondary);">Confidence:</span>
            <div class="confidence-fill">
              <div class="confidence-fill-inner" style="width: 85%"></div>
            </div>
            <span style="font-size: 11px;">85%</span>
          </div>
        </div>
        <div class="position-pnl">
          <div class="positive">+$125.50</div>
          <div class="position-details">+2.3%</div>
          <div class="risk-badge low" style="font-size: 10px; padding: 2px 8px; margin-top: 4px;">LOW RISK</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Risk Alerts -->
  <div class="card">
    <div class="card-title">Risk Alerts</div>
    <div class="alert-list" id="alert-list">
      <div class="alert-item">
        <span class="alert-icon">‚úÖ</span>
        <div>
          <div>All systems normal</div>
          <div class="sub-text">No active risk alerts</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let riskData = null;

  async function loadRiskData() {
    try {
      const res = await fetch('/api/risk/summary');
      if (res.ok) {
        riskData = await res.json();
        updateDashboard(riskData);
      }
    } catch (e) {
      console.error('Failed to load risk data:', e);
    }
  }

  function updateDashboard(data) {
    if (!data) return;

    // Portfolio value
    const equity = data.equity || 10000;
    document.getElementById('total-equity').textContent = '$' + equity.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    // Daily P/L
    const dailyPnl = data.daily_pnl || 0;
    const dailyPnlPct = data.daily_pnl_pct || 0;
    const dailyEl = document.getElementById('daily-pnl');
    dailyEl.textContent = (dailyPnl >= 0 ? '+' : '') + '$' + dailyPnl.toFixed(2) + ' (' + dailyPnlPct.toFixed(2) + '%)';
    dailyEl.className = dailyPnl >= 0 ? 'positive' : 'negative';

    // Risk level
    const riskLevel = data.risk_level || 'low';
    updateRiskGauge(riskLevel);
    
    // VaR
    const var95 = data.var_95 || 0;
    const varLimit = data.var_limit || equity * 0.05;
    const varUtil = varLimit > 0 ? (var95 / varLimit) * 100 : 0;
    document.getElementById('var-value').textContent = '$' + var95.toFixed(2);
    document.getElementById('var-util').textContent = varUtil.toFixed(0) + '%';
    document.getElementById('var-limit').textContent = '$' + varLimit.toFixed(0);
    document.getElementById('var-remaining').textContent = '$' + Math.max(0, varLimit - var95).toFixed(0);
    
    const varFill = document.getElementById('var-fill');
    varFill.style.width = Math.min(100, varUtil) + '%';
    varFill.className = 'progress-fill ' + (varUtil > 80 ? 'red' : (varUtil > 50 ? 'yellow' : 'green'));

    // Drawdown
    const drawdown = data.drawdown_pct || 0;
    const peakEquity = data.peak_equity || equity;
    const ddLimit = data.dd_limit || 10;
    document.getElementById('drawdown-value').textContent = drawdown.toFixed(2) + '%';
    document.getElementById('peak-equity').textContent = '$' + peakEquity.toLocaleString();
    document.getElementById('dd-percent').textContent = (Math.abs(drawdown) / ddLimit * 100).toFixed(0) + '% of limit';
    
    const ddFill = document.getElementById('dd-fill');
    const ddPercent = Math.abs(drawdown) / ddLimit * 100;
    ddFill.style.width = Math.min(100, ddPercent) + '%';
    ddFill.className = 'progress-fill ' + (ddPercent > 80 ? 'red' : (ddPercent > 50 ? 'yellow' : 'green'));

    // Performance metrics
    const sharpe = data.sharpe || 0;
    document.getElementById('sharpe-ratio').textContent = sharpe.toFixed(2);
    document.getElementById('sharpe-ratio').className = 'metric-value ' + (sharpe >= 1 ? 'positive' : (sharpe >= 0 ? 'neutral' : 'negative'));
    
    document.getElementById('sortino-ratio').textContent = (data.sortino || 0).toFixed(2);
    document.getElementById('win-rate').textContent = (data.win_rate || 50).toFixed(0) + '%';
    document.getElementById('profit-factor').textContent = (data.profit_factor || 1).toFixed(1);
    
    // Sharpe comment
    let sharpeComment = 'üìà Acceptable';
    if (sharpe >= 2) sharpeComment = 'üåü Excellent risk-adjusted returns!';
    else if (sharpe >= 1) sharpeComment = 'üëç Good risk-adjusted returns';
    else if (sharpe < 0) sharpeComment = '‚ö†Ô∏è Review needed - negative Sharpe';
    document.getElementById('sharpe-comment').textContent = sharpeComment;

    // Diversification
    const divScore = (data.diversification || 0.75) * 100;
    document.getElementById('div-score').textContent = divScore.toFixed(0) + '%';
    
    const corrRisk = data.correlation_risk || 0.3;
    document.getElementById('corr-risk').textContent = corrRisk > 0.7 ? 'High' : (corrRisk > 0.4 ? 'Medium' : 'Low');
    document.getElementById('corr-fill').style.width = (corrRisk * 100) + '%';
    document.getElementById('corr-fill').className = 'progress-fill ' + (corrRisk > 0.7 ? 'red' : (corrRisk > 0.4 ? 'yellow' : 'green'));
    
    document.getElementById('position-count').textContent = data.positions || 0;
    document.getElementById('positions-avail').textContent = data.positions_available || 10;

    // Allocation
    const allocCrypto = data.alloc_crypto || 40;
    const allocStocks = data.alloc_stocks || 35;
    const allocCash = 100 - allocCrypto - allocStocks;
    document.getElementById('alloc-crypto').style.width = allocCrypto + '%';
    document.getElementById('alloc-crypto').textContent = allocCrypto.toFixed(0) + '%';
    document.getElementById('alloc-stocks').style.width = allocStocks + '%';
    document.getElementById('alloc-stocks').textContent = allocStocks.toFixed(0) + '%';
    document.getElementById('alloc-cash').style.width = allocCash + '%';
    document.getElementById('alloc-cash').textContent = allocCash.toFixed(0) + '%';

    // Risk alerts
    const alerts = data.risk_flags || [];
    updateAlerts(alerts);

    // Positions
    if (data.positions_list) {
      updatePositionsList(data.positions_list);
    }
  }

  function updateRiskGauge(level) {
    const needle = document.getElementById('risk-needle');
    const text = document.getElementById('risk-level-text');
    const badge = document.getElementById('risk-badge');
    
    const angles = {
      'low': -60,
      'medium': -15,
      'high': 30,
      'critical': 60
    };
    
    const angle = angles[level] || -45;
    needle.style.transform = `rotate(${angle}deg)`;
    text.textContent = level.toUpperCase();
    
    badge.textContent = level.toUpperCase() + ' RISK';
    badge.className = 'risk-badge ' + level;
  }

  function updateAlerts(alerts) {
    const container = document.getElementById('alert-list');
    
    if (!alerts || alerts.length === 0) {
      container.innerHTML = `
        <div class="alert-item">
          <span class="alert-icon">‚úÖ</span>
          <div>
            <div>All systems normal</div>
            <div class="sub-text">No active risk alerts</div>
          </div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = alerts.map(alert => `
      <div class="alert-item">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div>
          <div>${alert}</div>
        </div>
      </div>
    `).join('');
  }

  function updatePositionsList(positions) {
    const container = document.getElementById('position-list');
    
    if (!positions || positions.length === 0) {
      container.innerHTML = `
        <div class="alert-item">
          <span class="alert-icon">üì≠</span>
          <div>No active positions</div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = positions.map(pos => {
      const pnlClass = pos.pnl >= 0 ? 'positive' : 'negative';
      const riskClass = pos.risk_tier || 'medium';
      const confidence = pos.confidence || 50;
      
      return `
        <div class="position-item">
          <div>
            <div class="position-symbol">${pos.symbol}</div>
            <div class="position-details">${pos.strategy} ‚Ä¢ Entry: $${pos.entry_price?.toFixed(2) || '0.00'}</div>
            <div class="confidence-bar">
              <span style="font-size: 11px; color: var(--text-secondary);">Confidence:</span>
              <div class="confidence-fill">
                <div class="confidence-fill-inner" style="width: ${confidence}%"></div>
              </div>
              <span style="font-size: 11px;">${confidence.toFixed(0)}%</span>
            </div>
          </div>
          <div class="position-pnl">
            <div class="${pnlClass}">${pos.pnl >= 0 ? '+' : ''}$${pos.pnl?.toFixed(2) || '0.00'}</div>
            <div class="position-details">${pos.pnl_pct >= 0 ? '+' : ''}${pos.pnl_pct?.toFixed(1) || '0.0'}%</div>
            <div class="risk-badge ${riskClass}" style="font-size: 10px; padding: 2px 8px; margin-top: 4px;">${riskClass.toUpperCase()}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Initial load
  loadRiskData();
  
  // Auto-refresh every 10 seconds
  setInterval(loadRiskData, 10000);
</script>
{% endblock %}
